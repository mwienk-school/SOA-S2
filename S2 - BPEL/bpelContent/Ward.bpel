<!-- Ward BPEL Process [Generated by the Eclipse BPEL Designer] -->
<!-- Date: Wed Mar 28 12:59:26 CEST 2012 -->
<bpel:process name="Ward" targetNamespace="http://www.PAHospital.org/WardService/"
	suppressJoinFailure="yes" xmlns:ward="http://www.PAHospital.org/WardService/"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:ts="http://www.PAHospital.org/TransportationService/" xmlns:lab="http://www.PAHospital.org/LabService/"
	xmlns:labcb="http://www.PAHospital.org/LabCallbackService/" xmlns:pat="http://www.PAHospital.org/PatService/"
	xmlns:rad="http://www.PAHospital.org/RadiologyService/" xmlns:radcb="http://www.PAHospital.org/RadiologyCallbackService/" xmlns:ns1="http://www.w3.org/2001/XMLSchema">

	<!-- Import the service WSDL -->
	<bpel:import location="WardArtifacts.wsdl"
		namespace="http://www.PAHospital.org/WardService/" importType="http://schemas.xmlsoap.org/wsdl/" />

	<!-- Import the PartnerLink WSDLs -->
	<bpel:import location="TranspService.wsdl"
		namespace="http://www.PAHospital.org/TransportationService/"
		importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="LabService.wsdl"
		namespace="http://www.PAHospital.org/LabService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="LabService-callback.wsdl"
		namespace="http://www.PAHospital.org/LabCallbackService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="PatService.wsdl"
		namespace="http://www.PAHospital.org/PatService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="RadService.wsdl"
		namespace="http://www.PAHospital.org/RadiologyService/" importType="http://schemas.xmlsoap.org/wsdl/" />
	<bpel:import location="RadService-callback.wsdl"
		namespace="http://www.PAHospital.org/RadiologyCallbackService/"
		importType="http://schemas.xmlsoap.org/wsdl/" />


	<!-- ================================================================= -->
	<!-- ORCHESTRATION LOGIC -->
	<!-- Set of activities coordinating the flow of messages across the -->
	<!-- services integrated within this business process -->
	<!-- ================================================================= -->
	<bpel:partnerLinks>
		<bpel:partnerLink name="WardService" partnerLinkType="ward:WardPLT"
			myRole="WardService" />
		<bpel:partnerLink name="TranspService"
			partnerLinkType="ward:TransportPLT" partnerRole="TransportService" />
		<bpel:partnerLink name="LabService" partnerLinkType="ward:LaboratoryPLT"
			partnerRole="LaboratoryService" myRole="LaboratoryRequester" />
		<bpel:partnerLink name="PatService" partnerLinkType="ward:PatientPLT"
			partnerRole="ElectronicPatientRecordService" />
		<bpel:partnerLink name="RadService" partnerLinkType="ward:RadiologyPLT"
			partnerRole="RadiologyService" myRole="RadiologyRequester" />
	</bpel:partnerLinks>

	<bpel:variables>
		<bpel:variable name="WardServiceRequest" messageType="ward:WardOrderPatientTreatmentRequest" />
		<bpel:variable name="WardServiceResponse" messageType="ward:WardOrderPatientTreatmentResponse" />
		<bpel:variable name="GetPatientIDRequest" messageType="pat:GetPatientIDsRequest" />
		<bpel:variable name="GetPatientIDResponse" messageType="pat:GetPatientIDsResponse" />
		<bpel:variable name="CreatePatientRequest" messageType="pat:CreatePatientRecordRequest" />
		<bpel:variable name="CreatePatientResponse" messageType="pat:CreatePatientRecordResponse" />
		<bpel:variable name="OrderRadiologyExamRequest"	messageType="rad:RadiologyOrderRadExaminationRequest" />
		<bpel:variable name="OrderRadiologyExamResponse" messageType="rad:RadiologyOrderRadExaminationResponse" />
		<bpel:variable name="OrderLabTestRequest" messageType="lab:LaboratoryOrderLabTestRequest" />
		<bpel:variable name="OrderLabTestResponse" messageType="lab:LaboratoryOrderLabTestResponse" />
		<bpel:variable name="RadiologyAppointmentRequest" messageType="rad:RadiologyRequestAppointmentRequest" />
		<bpel:variable name="RadiologyAppointmentResponse" messageType="rad:RadiologyRequestAppointmentResponse" />
		<bpel:variable name="RadPatientTransportRequest" messageType="ts:OrderPatientTransportRequest" />
		<bpel:variable name="LabSampleTransportRequest" messageType="ts:OrderSampleTransportRequest" />
		<bpel:variable name="RadiologyReportResponse" messageType="radcb:RadiologyReportRequest" />
		<bpel:variable name="StoreRadiologyReportRequest" messageType="pat:StoreRadiologyReportRequest" />
		<bpel:variable name="LabReportResponse" messageType="labcb:SendLabReportResponse" />
		<bpel:variable name="StoreLabReportRequest" messageType="pat:StoreLabReportRequest" />
<!-- 		<bpel:variable name="WardServicePaymentRequest" messageType="ward:WardPaymentRequest" /> -->
<!-- 		<bpel:variable name="WardServiceReceiveDischargeLetter" messageType="ward:WardDischargeLetter" /> -->
	</bpel:variables>
    
    <bpel:correlationSets>
        <bpel:correlationSet name="RadOrderID" properties="ward:RadiologyOrderID"></bpel:correlationSet>
        <bpel:correlationSet name="LabOrderID" properties="ward:LaboratoryOrderID"></bpel:correlationSet>
    </bpel:correlationSets>
    <bpel:sequence name="main">
		<bpel:receive name="Receive-AdmissionOrder" partnerLink="WardService"
			operation="OrderPatientTreatment" variable="WardServiceRequest"
			createInstance="yes" >
        </bpel:receive>
		<bpel:assign validate="no" name="Assign-Patient">
			<bpel:copy>
				<bpel:from>
					<bpel:literal xml:space="preserve"><s0:Patient
						xmlns:s0="http://www.PAHospital.org/PatService/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
                            <PatientID>PatientID</PatientID>
  							<PatientName>PatientName</PatientName>
  							<PatientStreet>PatientStreet</PatientStreet>
  							<PatientZipCode>0</PatientZipCode>
  							<PatientCity>PatientCity</PatientCity>
  							<PatientBirthday>2001-01-01</PatientBirthday>
                        </s0:Patient></bpel:literal>
				</bpel:from>
				<bpel:to variable="CreatePatientRequest" part="Patient"></bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from>
					<bpel:literal>
						<s0:PatientName xmlns:s0="http://www.PAHospital.org/PatService/"
							xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
							s0:PatientName
						</s0:PatientName>
					</bpel:literal>
				</bpel:from>
				<bpel:to variable="GetPatientIDRequest" part="PatientName"></bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from variable="WardServiceRequest" part="PatientTreatmentOrder">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
				</bpel:from>
				<bpel:to variable="GetPatientIDRequest" part="PatientName"></bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="PatientTreatmentOrder" variable="WardServiceRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
				</bpel:from>
				<bpel:to part="Patient" variable="CreatePatientRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientName]]></bpel:query>
				</bpel:to>
			</bpel:copy>
			<bpel:copy>
				<bpel:from part="PatientTreatmentOrder" variable="WardServiceRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
				</bpel:from>
				<bpel:to part="Patient" variable="CreatePatientRequest">
					<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
				</bpel:to>
			</bpel:copy>
		</bpel:assign>
		<bpel:invoke name="Invoke-GetPatientID" partnerLink="PatService"
			operation="GetPatientIDsByName" inputVariable="GetPatientIDRequest"
			outputVariable="GetPatientIDResponse" />
		<bpel:if name="If-PatientExists">
			<bpel:condition><![CDATA[number($GetPatientIDResponse.PatientIDsList/PatientID) = $GetPatientIDResponse.PatientIDsList/PatientID]]></bpel:condition>
			<bpel:sequence name="ExistingPatient">
				<bpel:assign validate="no" name="Assign-PatientID">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<s0:LabOrder xmlns:s0="http://www.PAHospital.org/LabService/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<PatientID>PatientID</PatientID>
									<CaseID>CaseID</CaseID>
									<SampleID>SampleID</SampleID>
									<SampleMaterial>BLOOD</SampleMaterial>
									<LabParameter>LabParameter</LabParameter>
								</s0:LabOrder>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="OrderLabTestRequest" part="LabOrder"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<s0:RadiologyOrder xmlns:s0="http://www.PAHospital.org/RadiologyService/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<PatientID>PatientID</PatientID>
									<CaseID>CaseID</CaseID>
									<ExaminationType>XRAY</ExaminationType>
								</s0:RadiologyOrder>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="OrderRadiologyExamRequest" part="Order"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="PatientIDsList" variable="GetPatientIDResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID[1]]]></bpel:query>
						</bpel:from>
						<bpel:to part="Order" variable="OrderRadiologyExamRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="PatientIDsList" variable="GetPatientIDResponse">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID[1]]]></bpel:query>
						</bpel:from>
						<bpel:to part="LabOrder" variable="OrderLabTestRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
						</bpel:to>
					</bpel:copy>
                    
                </bpel:assign>
			</bpel:sequence>
			<bpel:else>
				<bpel:sequence name="NewPatient">
					<bpel:invoke name="Invoke-CreatePatient" partnerLink="PatService"
						operation="CreatePatientRecord" portType="pat:ElectronicPatientRecord"
						inputVariable="CreatePatientRequest" outputVariable="CreatePatientResponse" />
					<bpel:assign validate="no" name="Assign-PatientID">
						<bpel:copy>
							<bpel:from>
								<bpel:literal>
									<s0:LabOrder xmlns:s0="http://www.PAHospital.org/LabService/"
										xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<PatientID>PatientID</PatientID>
										<CaseID>CaseID</CaseID>
										<SampleID>SampleID</SampleID>
										<SampleMaterial>BLOOD</SampleMaterial>
										<LabParameter>LabParameter</LabParameter>
									</s0:LabOrder>
								</bpel:literal>
							</bpel:from>
							<bpel:to variable="OrderLabTestRequest" part="LabOrder"></bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from>
								<bpel:literal>
									<s0:RadiologyOrder
										xmlns:s0="http://www.PAHospital.org/RadiologyService/"
										xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
										<PatientID>PatientID</PatientID>
										<CaseID>CaseID</CaseID>
										<ExaminationType>XRAY</ExaminationType>
									</s0:RadiologyOrder>
								</bpel:literal>
							</bpel:from>
							<bpel:to variable="OrderRadiologyExamRequest" part="Order"></bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="PatientID" variable="CreatePatientResponse">
							</bpel:from>
							<bpel:to part="Order" variable="OrderRadiologyExamRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                                    <![CDATA[PatientID]]>
								</bpel:query>
							</bpel:to>
						</bpel:copy>
						<bpel:copy>
							<bpel:from part="PatientID" variable="CreatePatientResponse"></bpel:from>
							<bpel:to part="LabOrder" variable="OrderLabTestRequest">
								<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
							</bpel:to>
						</bpel:copy>
					</bpel:assign>
				</bpel:sequence>
			</bpel:else>
		</bpel:if>

 		<bpel:flow name="Flow-Examination">
  			<bpel:sequence name="Radiology">
				<bpel:invoke name="Invoke-RadiologyExam" partnerLink="RadService"
					operation="OrderRadiologyExamination" portType="rad:Radiology"
					inputVariable="OrderRadiologyExamRequest" outputVariable="OrderRadiologyExamResponse" >
                    <bpel:correlations>
                        <bpel:correlation set="RadOrderID" initiate="yes" pattern="response"></bpel:correlation>
                    </bpel:correlations>
                </bpel:invoke>
				<bpel:assign validate="no" name="Assign-RadiologyOrder">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<s0:PatientOrder
									xmlns:s0="http://www.PAHospital.org/TransportationService/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<PatientID>PatientID</PatientID>
									<RequestingUnit>RequestingUnit</RequestingUnit>
									<DestinationUnit>DestinationUnit</DestinationUnit>
									<TransportationDate>2001-12-31T12:00:00</TransportationDate>
								</s0:PatientOrder>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="RadPatientTransportRequest" part="PatientTransportOrder"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<s0:Appointment xmlns:s0="http://www.PAHospital.org/RadiologyService/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<OrderID>OrderID</OrderID>
									<Date>2001-01-01</Date>
								</s0:Appointment>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="RadiologyAppointmentRequest" part="RadiologyAppointmentRequest"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="RadiologyOrderID" variable="OrderRadiologyExamResponse"></bpel:from>
						<bpel:to part="RadiologyAppointmentRequest" variable="RadiologyAppointmentRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[OrderID]]></bpel:query>
						</bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="Order" variable="OrderRadiologyExamRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
						</bpel:from>
						<bpel:to part="PatientTransportOrder" variable="RadPatientTransportRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="Invoke-RadiologyAppointment"
					partnerLink="RadService" operation="RequestAppointment" portType="rad:Radiology"
					inputVariable="RadiologyAppointmentRequest" outputVariable="RadiologyAppointmentResponse" >
                </bpel:invoke>
				<bpel:invoke name="Invoke-TransportPatient" partnerLink="TranspService"
					operation="OrderPatientTransport" inputVariable="RadPatientTransportRequest" >
                </bpel:invoke>
				<bpel:receive name="Receive-RadiologyReport"
 					partnerLink="RadService" operation="SendRadiologyReport" variable="RadiologyReportResponse" >
                    <bpel:correlations>
                        <bpel:correlation set="RadOrderID" initiate="no"></bpel:correlation>
                    </bpel:correlations>
                </bpel:receive>
				<bpel:assign validate="no" name="Assign-RadiologyReport">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<s0:RadiologyReport xmlns:s0="http://www.PAHospital.org/PatService/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<PatientID>PatientID</PatientID>
									<RadiologyOrderID>RadiologyOrderID</RadiologyOrderID>
									<DateOfExamination>2001-01-01</DateOfExamination>
									<ReportText>ReportText</ReportText>
								</s0:RadiologyReport>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="StoreRadiologyReportRequest" part="RadiologyReport"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="RadiologyReport" variable="RadiologyReportResponse"></bpel:from>
						<bpel:to part="RadiologyReport" variable="StoreRadiologyReportRequest"></bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="Invoke-StoreReport" partnerLink="PatService"
					operation="StoreRadiologyReport" portType="pat:ElectronicPatientRecord"
					inputVariable="StoreRadiologyReportRequest" >
                </bpel:invoke>
			</bpel:sequence>

 			<bpel:sequence name="Laboratory">
				<bpel:invoke name="Invoke-OrderLabTest" partnerLink="LabService"
					operation="OrderLabTest" portType="lab:Laboratory" inputVariable="OrderLabTestRequest"
					outputVariable="OrderLabTestResponse" >
                    <bpel:correlations>
                        <bpel:correlation set="LabOrderID" initiate="yes" pattern="response"></bpel:correlation>
                    </bpel:correlations>
                </bpel:invoke>
				<bpel:assign validate="no" name="Assign-LaboratoryOrder">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<s0:SampleOrder
									xmlns:s0="http://www.PAHospital.org/TransportationService/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<PatientID>PatientID</PatientID>
									<RequestingUnit>RequestingUnit</RequestingUnit>
									<SampleID>SampleID</SampleID>
								</s0:SampleOrder>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="LabSampleTransportRequest" part="SampleTransportOrder"></bpel:to>
					</bpel:copy>
					<bpel:copy>
						<bpel:from part="LabOrder" variable="OrderLabTestRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
						</bpel:from>
						<bpel:to part="SampleTransportOrder" variable="LabSampleTransportRequest">
							<bpel:query queryLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0"><![CDATA[PatientID]]></bpel:query>
						</bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="Invoke-OrderSampleTransport"
					partnerLink="TranspService" operation="OrderSampleTransport"
					portType="ts:Transportation" inputVariable="LabSampleTransportRequest" />
     			<bpel:receive name="Receive-LabReport" partnerLink="LabService"
	 					operation="SendLabReport" variable="LabReportResponse" >
                    <bpel:correlations>
                        <bpel:correlation set="LabOrderID" initiate="no"></bpel:correlation>
                    </bpel:correlations>
                </bpel:receive>
				<bpel:assign validate="no" name="Assign-LabReport">
					<bpel:copy>
						<bpel:from>
							<bpel:literal>
								<s0:LabReport xmlns:s0="http://www.PAHospital.org/PatService/"
									xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
									<LabOrderID>LabOrderID</LabOrderID>
									<PatientID>PatientID</PatientID>
									<SampleID>SampleID</SampleID>
									<LabValues>
										<LabParameter>LabParameter</LabParameter>
										<LabValue>0.0</LabValue>
									</LabValues>
								</s0:LabReport>
							</bpel:literal>
						</bpel:from>
						<bpel:to variable="StoreLabReportRequest" part="LabReport"></bpel:to>
					</bpel:copy>
 					<bpel:copy>
						<bpel:from part="LabReport" variable="LabReportResponse"></bpel:from>
						<bpel:to part="LabReport" variable="StoreLabReportRequest"></bpel:to>
					</bpel:copy>
				</bpel:assign>
				<bpel:invoke name="Invoke-StoreReport" partnerLink="PatService"
					operation="StoreLabReport" portType="pat:ElectronicPatientRecord"
					inputVariable="StoreLabReportRequest" />
			</bpel:sequence>-->
		</bpel:flow> 

<!-- 		<bpel:flow name="Flow-Review"> -->
<!-- 			<bpel:sequence name="ReviewReports"> -->
<!-- 				<bpel:receive name="Receive-DischargeLetter" -->
<!-- 					partnerLink="WardService" operation="ReceiveDischargeLetter" -->
<!-- 					portType="ward:Ward" variable="WardServiceReceiveDischargeLetter" /> -->
<!-- 			</bpel:sequence> -->
<!-- 			<bpel:sequence name="Payment"> -->
<!-- 				<bpel:receive name="Receive-Payment" partnerLink="WardService" -->
<!-- 					operation="ReceivePayment" portType="ward:Ward" variable="WardServicePaymentRequest" /> -->
<!-- 			</bpel:sequence> -->
<!-- 		</bpel:flow> -->
		<bpel:assign validate="no" name="Assign-Discharge">
			<bpel:copy>
				<bpel:from>
					<bpel:literal>
						<s0:DischargeLetter xmlns:s0="http://www.PAHospital.org/WardService/"
							xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
							<name>name</name>
							<message>message</message>
						</s0:DischargeLetter>
					</bpel:literal>
				</bpel:from>
				<bpel:to variable="WardServiceResponse" part="DischargeLetter"></bpel:to>
			</bpel:copy>
<!-- 			<bpel:copy> -->
<!-- 				<bpel:from part="DischargeLetter" variable="WardServiceReceiveDischargeLetter"> -->
<!-- 				</bpel:from> -->
<!-- 				<bpel:to part="DischargeLetter" variable="WardServiceResponse"> -->
<!-- 				</bpel:to> -->
<!-- 			</bpel:copy> -->
		</bpel:assign>
		<bpel:reply name="Reply-DischargeLetter" partnerLink="WardService"
			operation="OrderPatientTreatment" variable="WardServiceResponse" />
	</bpel:sequence>
</bpel:process>